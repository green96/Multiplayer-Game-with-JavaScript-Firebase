<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <link rel="stylesheet" href="styles.css"> 
</head>

<body>
  

<div class="game-container">
</div>
 <div class="player-info">
      <div>
        <h1 id="tenGame">Ph√≤ng Lofi</h1>
        <label for="player-name">Your Name</label>
        <input id="player-name" maxlength="10" type="text" />
      </div>
      <div>
        <button id="player-color">Change Color</button>
        <button id="play-music-btn">üéµ B·∫≠t nh·∫°c n·ªÅn</button>

        <audio id="bg-music" loop>
          <source src="Soothing Breeze üçÉ [asian lofi].mp3" type="audio/mpeg">
          Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t nh·∫°c.
        </audio>

        <script>
          const music = document.getElementById("bg-music");
          const playBtn = document.getElementById("play-music-btn");

          playBtn.addEventListener("click", () => {
            music.play();
            playBtn.style.display = "none"; // ·∫©n n√∫t sau khi ph√°t
          });
        </script>
      </div>
    </div> 
  <script type="module">
    
    // Trong Firebase v12 t·∫•t c·∫£ script ph·∫£i c√≥ type="module"

    // Firebase v12 - Modular

    // import { trong ƒë√¢y l√† h√†m c·∫ßn import c·ªßa firebase }
    // connect to firebase app 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    // connect to authentication part (allow to login into firebase and be authenticated to autually write and read data from or to it )
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    // connect to fire base the real-time
    import { getDatabase, ref, set, update, remove,
  onValue, onChildAdded, onChildRemoved, onDisconnect } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCjUsuha1M4gBOTJHnmpuiZ0165UkQ7NTQ",
      authDomain: "multiplayer-game-e9a14.firebaseapp.com",
      databaseURL: "https://multiplayer-game-e9a14-default-rtdb.firebaseio.com",
      projectId: "multiplayer-game-e9a14",
      storageBucket: "multiplayer-game-e9a14.appspot.com",
      messagingSenderId: "953491389081",
      appId: "1:953491389081:web:37ff4680362c23b2849608",
      measurementId: "G-QCVFPD9RVE"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Login anonymously
    signInAnonymously(auth)
      .then(() => {
        console.log("‚úÖ ƒêƒÉng nh·∫≠p ·∫©n danh th√†nh c√¥ng");
      })
      .catch((error) => {
        console.error("‚ùå L·ªói khi ƒëƒÉng nh·∫≠p:", error);
      });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const playerId = user.uid;
        const playerRef = ref(db, `players/${playerId}`);

        // G·ª≠i d·ªØ li·ªáu ng∆∞·ªùi ch∆°i l√™n Firebase
        set(playerRef, {
          id: playerId,
          name: "DREW",
          x: 3,
          y: 3,
          coins: 0,
          direction: "right",
          color: "blue"
        });

        // X√≥a d·ªØ li·ªáu khi ng·∫Øt k·∫øt n·ªëi
        onDisconnect(playerRef).remove()
          .then(() => {
            console.log("üì§ S·∫Ω t·ª± ƒë·ªông x√≥a khi disconnect");
          })
          .catch((err) => {
            console.error("‚ùå L·ªói khi thi·∫øt l·∫≠p onDisconnect:", err);
          });

        console.log("üë§ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:", user.uid);
      }
    });


 // Data & helper functions
    const mapData = {
      minX: 1, maxX: 14, minY: 4, maxY: 12,
      blockedSpaces: { "7x4": true, "1x11": true, "12x10": true, "4x7": true,
        "5x7": true, "6x7": true, "8x6": true, "9x6": true, "10x6": true,
        "7x9": true, "8x9": true, "9x9": true
      }
    };
    const playerColors = ["blue","red","orange","yellow","green","purple"];
    function randomFromArray(a){ return a[Math.floor(Math.random()*a.length)]; }
    function getKeyString(x, y){ return `${x}x${y}`; }
    function createName(){
      return `${randomFromArray(["COOL","SUPER","HIP","BUFF","SOFT","DARK"])} ${randomFromArray(["DOG","CAT","LION","BUG","BIRD","SEAL"])}`;
    }
    function isSolid(x,y){
      const b = mapData.blockedSpaces[getKeyString(x,y)];
      return b || x < mapData.minX || x >= mapData.maxX || y < mapData.minY || y >= mapData.maxY;
    }
function getRandomSafeSpot(){
  const safeSpots = [];

  for (let x = mapData.minX; x < mapData.maxX; x++) {
    for (let y = mapData.minY; y < mapData.maxY; y++) {
      const key = getKeyString(x, y);

      // B·ªè qua n·∫øu trong danh s√°ch c·∫•m
      if (bannedSpots.includes(key)) continue;

      // B·ªè qua n·∫øu b·ªã block, c√≥ coin, ho·∫∑c c√≥ player
      const hasCoin = coins[key];
      const hasPlayer = Object.values(players).some(p => p.x === x && p.y === y);

      if (!isSolid(x, y) && !hasCoin && !hasPlayer) {
        safeSpots.push({ x, y });
      }
    }
  }

  if (safeSpots.length === 0) return { x: mapData.minX, y: mapData.minY };
  return randomFromArray(safeSpots);
}


    // Game state & DOM elements
    let playerId, playerRef;
    let players = {}, playerEls = {}, coins = {}, coinEls = {};
    const gameContainer = document.querySelector(".game-container");
    const playerNameInput = document.querySelector("#player-name");
    const playerColorButton = document.querySelector("#player-color");

    // Game logic functions
    function placeCoin(){
  const {x, y} = getRandomSafeSpot();
  const key = getKeyString(x, y);

  // Tr√°nh tr√πng key
  if (!coins[key]) {
    set(ref(db, `coins/${key}`), { x, y });
  }

  setTimeout(placeCoin, randomFromArray([2000,3000,4000,5000]));
}


    function attemptGrabCoin(x, y){
      const key = getKeyString(x,y);
      if (coins[key]) {
        remove(ref(db, `coins/${key}`));
        update(playerRef, { coins: players[playerId].coins + 1 });
      }
    }

    function handleArrowPress(dx=0, dy=0){
      const newX = players[playerId].x + dx;
      const newY = players[playerId].y + dy;
      if (!isSolid(newX, newY)) {
        players[playerId].x = newX;
        players[playerId].y = newY;
        players[playerId].direction = dx > 0 ? "right" : dx < 0 ? "left" : players[playerId].direction;
        set(playerRef, players[playerId]);
        attemptGrabCoin(newX, newY);
      }
    }

    function initGame(){
      ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].forEach(code => {
        let ok = true;
        window.addEventListener("keydown", e => {
          if (e.code === code && ok) {
            ok = false;
            const moves = {ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};
            handleArrowPress(...moves[code]);
          }
        });
        window.addEventListener("keyup", e=>{ if(e.code===code) ok=true; });
      });

      const pRef = ref(db, "players");
      const cRef = ref(db, "coins");

      onValue(pRef, snap => {
        players = snap.val() || {};
        for (const k of Object.keys(players)) {
          const s = players[k], el = playerEls[k];
          if (el) {
            el.querySelector(".Character_name").innerText = s.name;
            el.querySelector(".Character_coins").innerText = s.coins;
            el.dataset.color = s.color;
            el.dataset.direction = s.direction;
            el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;
          }
        }
      });

      onChildAdded(pRef, snap => {
        const s = snap.val();
        const el = document.createElement("div");
        el.className = `Character grid-cell${s.id===playerId? " you":""}`;
        el.innerHTML = `
          <div class="Character_shadow grid-cell"></div>
          <div class="Character_sprite grid-cell"></div>
          <div class="Character_name-container">
            <span class="Character_name">${s.name}</span>
            <span class="Character_coins">${s.coins}</span>
          </div>
          <div class="Character_you-arrow"></div>
        `;
        el.dataset.color = s.color;
        el.dataset.direction = s.direction;
        el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;
        gameContainer.appendChild(el);
        playerEls[s.id] = el;
      });

      onChildRemoved(pRef, snap => {
        const id = snap.val().id;
        const el = playerEls[id];
        if (el) { gameContainer.removeChild(el); delete playerEls[id]; }
      });

      onValue(cRef, snap => { coins = snap.val() || {}; });

      onChildAdded(cRef, snap => {
        const s = snap.val(), key=getKeyString(s.x, s.y);
        coins[key] = true;
        const el = document.createElement("div");
        el.className = "Coin grid-cell";
        el.innerHTML = `
          <div class="Coin_shadow grid-cell"></div>
          <div class="Coin_sprite grid-cell"></div>
        `;
        el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;
        gameContainer.appendChild(el);
        coinEls[key] = el;
      });

      onChildRemoved(cRef, snap => {
        const {x, y} = snap.val(), key = getKeyString(x,y);
        const el = coinEls[key];
        if (el) { gameContainer.removeChild(el); delete coinEls[key]; }
      });

      playerNameInput.addEventListener("change", e => {
        const nm = e.target.value || createName();
        playerNameInput.value = nm;
        update(playerRef, { name: nm });
      });

      playerColorButton.addEventListener("click", () => {
        const i = playerColors.indexOf(players[playerId].color);
        const next = playerColors[(i+1) % playerColors.length];
        update(playerRef, { color: next });
      });

      placeCoin();
    }

    // Sau khi DOM s·∫µn s√†ng
    window.addEventListener("load", () => {
      onAuthStateChanged(auth, user => {
        if (user) {
          playerId = user.uid;
          playerRef = ref(db, `players/${playerId}`);

          const name = createName();
          playerNameInput.value = name;
          const { x, y } = getRandomSafeSpot();

          set(playerRef, {
            id: playerId,
            name, direction: "right",
            color: randomFromArray(playerColors),
            x, y, coins: 0
          });

          onDisconnect(playerRef).remove();
          initGame();
        }
      });
      signInAnonymously(auth).catch(console.error);
    });


  const bannedSpots = [
  "8x3", "9x3",         // Gh·∫ø ƒë·ªè b√™n ph·∫£i
  "6x3", "7x3",         // B√†n gi·ªØa
  "3x3", "4x3",         // B√†n tr√°i
  "4x2", "2x2",         // Gh·∫ø tr√™n
  "7x5",                // V√πng n·ªÅn xanh d∆∞∆°ng (v√≠ d·ª•)
  "5x1", "6x1",         // Khu xanh d∆∞∆°ng tr√™n c√πng (cafe-pizza)
  // ... th√™m ti·∫øp c√°c t·ªça ƒë·ªô kh√°c n·∫øu c·∫ßn
];


  class KeyPressListener {
  constructor(keyCode, callback) {
    let keySafe = true;
    this.keydownFunction = function(event) {
      if (event.code === keyCode) {
         if (keySafe) {
            keySafe = false;
            callback();
         }  
      }
   };
   this.keyupFunction = function(event) {
      if (event.code === keyCode) {
         keySafe = true;
      }         
   };
   document.addEventListener("keydown", this.keydownFunction);
   document.addEventListener("keyup", this.keyupFunction);
  }

  unbind() { 
    document.removeEventListener("keydown", this.keydownFunction);
    document.removeEventListener("keyup", this.keyupFunction);
  }


}

  </script>


</body>

</html>


