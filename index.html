<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <link rel="stylesheet" href="styles.css"> 
</head>

<body>
  

<div class="game-container">
</div>
 <div class="player-info">
      <div>
        <h1 id="tenGame">PhÃ²ng Lofi</h1>
        <label for="player-name">Name(chatbox)</label>
        <input id="player-name" maxlength="30" type="text" />
      </div>
      <div>
        <button id="player-color">Change Color</button>
        <button id="play-music-btn">ğŸµ Báº­t nháº¡c ná»n</button>
        <!-- Tháº» <audio> Ä‘á»ƒ nhÃºng nháº¡c ná»n -->
        <audio id="bg-music" loop> <!-- loop: phÃ¡t láº·p láº¡i mÃ£i -->
          <source src="Soothing Breeze ğŸƒ [asian lofi].mp3" type="audio/mpeg">
          <!-- DÃ²ng dÆ°á»›i hiá»ƒn thá»‹ náº¿u trÃ¬nh duyá»‡t khÃ´ng há»— trá»£ -->
          TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ phÃ¡t nháº¡c.
        </audio>
        <script>
          // Láº¥y Ä‘á»‘i tÆ°á»£ng <audio> dá»±a vÃ o id
          const music = document.getElementById("bg-music");
           // Láº¥y nÃºt cÃ³ id="play-music-btn" (nÃºt nháº¥n Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¡t nháº¡c)
          const playBtn = document.getElementById("play-music-btn");

          // Khi ngÆ°á»i dÃ¹ng click vÃ o nÃºt
          playBtn.addEventListener("click", () => {
            music.play();                   // Báº¯t Ä‘áº§u phÃ¡t nháº¡c
            playBtn.style.display = "none"; // áº©n nÃºt sau khi phÃ¡t
          });
        </script>
      </div>
    </div> 
  <script type="module">
    
    // Trong Firebase v12 táº¥t cáº£ script pháº£i cÃ³ type="module"

    // Firebase v12 - Modular

    // import { trong Ä‘Ã¢y lÃ  ten hÃ m cáº§n import cá»§a firebase }
    // Import cÃ¡c thÆ° viá»‡n tá»« Firebase
    // connect to firebase app 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    // connect to authentication part (allow to login into firebase and be authenticated to autually write and read data from or to it )
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    // connect to fire base the real-time
    import { getDatabase, ref, set, update, remove,
  onValue, onChildAdded, onChildRemoved, onDisconnect } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Your Firebase config(Ä‘Æ°á»£c cáº¥p khi host firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyCjUsuha1M4gBOTJHnmpuiZ0165UkQ7NTQ",
      authDomain: "multiplayer-game-e9a14.firebaseapp.com",
      databaseURL: "https://multiplayer-game-e9a14-default-rtdb.firebaseio.com",
      projectId: "multiplayer-game-e9a14",
      storageBucket: "multiplayer-game-e9a14.appspot.com",
      messagingSenderId: "953491389081",
      appId: "1:953491389081:web:37ff4680362c23b2849608",
      measurementId: "G-QCVFPD9RVE"
    };

    // Init Firebase(Khá»Ÿi táº¡o Firebase)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);


//signInAnonymously(auth)	YÃªu cáº§u Firebase táº¡o má»™t tÃ i khoáº£n táº¡m thá»i áº©n danh cho ngÆ°á»i dÃ¹ng
    
  // Login anonymously(ÄÄƒng nháº­p áº©n danh vÃ o Firebase)
    signInAnonymously(auth)
      .then(() => {
        console.log("âœ… ÄÄƒng nháº­p áº©n danh thÃ nh cÃ´ng");
      })
      //if something goes wrong this error message will appear
      .catch((error) => {
        console.error("âŒ Lá»—i khi Ä‘Äƒng nháº­p:", error);
      });


//onAuthStateChanged() lÃ  má»™t hÃ m cá»§a Firebase Authentication, dÃ¹ng Ä‘á»ƒ theo dÃµi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p cá»§a ngÆ°á»i dÃ¹ng theo thá»i gian thá»±c.
/*
ThÃ nh pháº§n	Ã nghÄ©a
auth	Äá»‘i tÆ°á»£ng xÃ¡c thá»±c tá»« getAuth()
onAuthStateChanged(...)	ÄÄƒng kÃ½ má»™t listener Ä‘á»ƒ láº¯ng nghe sá»± thay Ä‘á»•i tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
(user) => { ... }	Callback Ä‘Æ°á»£c gá»i má»—i khi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p thay Ä‘á»•i
*/

    //Sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
    onAuthStateChanged(auth, (user) => {
      //Kiá»ƒm tra xem cÃ³ ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a. Biáº¿n user thÆ°á»ng láº¥y tá»« onAuthStateChanged(auth, (user) => { ... }).
      if (user) {
        //You're logged in!
        /*
        const playerId = user.uid;
        Má»—i ngÆ°á»i dÃ¹ng Firebase (ká»ƒ cáº£ Ä‘Äƒng nháº­p áº©n danh) Ä‘á»u cÃ³ má»™t uid riÃªng biá»‡t.
        uid nÃ y lÃ  ID duy nháº¥t toÃ n cáº§u, báº¡n cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ Ä‘á»‹nh danh ngÆ°á»i chÆ¡i trong cÆ¡ sá»Ÿ dá»¯ liá»‡u.
        */
        const playerId = user.uid;// ID duy nháº¥t cá»§a ngÆ°á»i chÆ¡i


        /*
        const playerRef = ref(db, \players/${playerId}`);`
        Táº¡o má»™t tham chiáº¿u (reference) Ä‘áº¿n vá»‹ trÃ­ trong Realtime Database táº¡i Ä‘Æ°á»ng dáº«n:
        */
        const playerRef = ref(db, `players/${playerId}`);

        // Gá»­i dá»¯ liá»‡u ngÆ°á»i chÆ¡i lÃªn Firebase(Ghi thÃ´ng tin ngÆ°á»i chÆ¡i vÃ o database)
        // Gá»­i lÃªn theo kiá»ƒu object( gá»“m key:value) vÃ  Ä‘á»• vÃ o playerRef
        set(playerRef, {
          id: playerId,
          name, //	TÃªn ngÆ°á»i chÆ¡i (biáº¿n name Ä‘Æ°á»£c láº¥y tá»« input ngÆ°á»i dÃ¹ng nháº­p)
          x,
          y,
          coins: 0,
          direction: "right", //HÆ°á»›ng nhÃ¬n ban Ä‘áº§u cá»§a ngÆ°á»i chÆ¡i
          color: randomFromArray(playerColors) //GÃ¡n mÃ u ngáº«u nhiÃªn tá»« danh sÃ¡ch playerColors
        });


/*
onDisconnect(playerRef).remove();
DÃ²ng nÃ y thiáº¿t láº­p cho Firebase má»™t hÃ nh Ä‘á»™ng tá»± Ä‘á»™ng khi ngÆ°á»i chÆ¡i bá»‹ ngáº¯t káº¿t ná»‘i khá»i server:
ğŸ‘‰ XÃ³a dá»¯ liá»‡u cá»§a ngÆ°á»i chÆ¡i khá»i Firebase Realtime Database.
ThÃ nh pháº§n	Ã nghÄ©a
playerRef	Tham chiáº¿u tá»›i vá»‹ trÃ­ ngÆ°á»i chÆ¡i trong Realtime Database (players/UID)
onDisconnect(playerRef)	Thiáº¿t láº­p hÃ nh vi khi client máº¥t káº¿t ná»‘i máº¡ng, Ä‘Ã³ng tab, táº¯t app,...
.remove()	Khi bá»‹ ngáº¯t káº¿t ná»‘i â†’ xÃ³a dá»¯ liá»‡u á»Ÿ playerRef
*/

        // Tá»± Ä‘á»™ng xÃ³a ngÆ°á»i chÆ¡i khi máº¥t káº¿t ná»‘i
        onDisconnect(playerRef).remove()// Do something when player disconnect from session
          .then(() => {
            console.log("ğŸ“¤ Sáº½ tá»± Ä‘á»™ng xÃ³a khi disconnect");
          })
          .catch((err) => {
            console.error("âŒ Lá»—i khi thiáº¿t láº­p onDisconnect:", err);
          });

        console.log("ğŸ‘¤ NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p:", user.uid);
      }
    });


 // Data & helper functions(ğŸŒ Dá»¯ liá»‡u báº£n Ä‘á»“ & HÃ m há»— trá»£)
    const mapData = {
      minX: 1, maxX: 14, minY: 4, maxY: 12,//This is the border of our game map
      // CÃ¡c Ã´ khÃ´ng Ä‘Æ°á»£c Ä‘i vÃ o
      blockedSpaces: { "7x4": true, "1x11": true, "12x10": true, "4x7": true,
        "5x7": true, "6x7": true, "8x6": true, "9x6": true, "10x6": true,
        "7x9": true, "8x9": true, "9x9": true
      }
    };

    // Options for Player Colors... these are in the same order as our sprite sheet
    const playerColors = ["blue","red","orange","yellow","green","purple"];
    //take an array and return a random number of that array
    function randomFromArray(a){ return a[Math.floor(Math.random()*a.length)]; }
    //gird coordinates(x and y value)==> return x and y as a string
    function getKeyString(x, y){ return `${x}x${y}`; }// Táº¡o key dáº¡ng "3x5"
    // Táº¡o tÃªn ngáº«u nhiÃªn
    function createName(){
      // return random prefix named from string array and random animal named from string array
      return `${randomFromArray(["COOL","SUPER","HIP","BUFF","SOFT","DARK"])} ${randomFromArray(["DOG","CAT","LION","BUG","BIRD","SEAL"])}`;
    }
    // HÃ m isSolid(x, y) dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem Ã´ (x, y) trÃªn báº£n Ä‘á»“ cÃ³ pháº£i lÃ  Ã´ "khÃ´ng thá»ƒ Ä‘i vÃ o" (solid / bá»‹ cháº·n) hay khÃ´ng.
    function isSolid(x,y){
      const b = mapData.blockedSpaces[getKeyString(x,y)];//getKeyString(x, y) táº¡o ra chuá»—i khÃ³a tá»« tá»a Ä‘á»™, vÃ­ dá»¥: "4x7".mapData.blockedSpaces lÃ  má»™t Ä‘á»‘i tÆ°á»£ng chá»©a danh sÃ¡ch cÃ¡c Ã´ bá»‹ cháº·n (tÆ°á»ng, Ä‘Ã¡, v.v.).Náº¿u tá»“n táº¡i b, nghÄ©a lÃ  Ã´ Ä‘Ã³ bá»‹ cháº·n.
      return b || x < mapData.minX || x >= mapData.maxX || y < mapData.minY || y >= mapData.maxY;//HÃ m sáº½ tráº£ vá» true náº¿u má»™t trong cÃ¡c Ä‘iá»u kiá»‡n sau Ä‘Ãºng:b: Ã” (x, y) bá»‹ cháº·n.x < minX hoáº·c x >= maxX: VÆ°á»£t trÃ¡i/pháº£i báº£n Ä‘á»“.y < minY hoáº·c y >= maxY: VÆ°á»£t trÃªn/dÆ°á»›i báº£n Ä‘á»“.
    }
//Chá»n má»™t vá»‹ trÃ­ an toÃ n Ä‘á»ƒ xuáº¥t hiá»‡n
function getRandomSafeSpot(){
  const safeSpots = [];//Khá»Ÿi táº¡o máº£ng safeSpots Ä‘á»ƒ chá»©a táº¥t cáº£ nhá»¯ng vá»‹ trÃ­ há»£p lá»‡ (an toÃ n).

  //Duyá»‡t toÃ n bá»™ báº£n Ä‘á»“:
  //Duyá»‡t toÃ n bá»™ cÃ¡c Ã´ (x, y) trong báº£n Ä‘á»“ báº±ng cÃ¡ch dÃ¹ng minX â†’ maxX, minY â†’ maxY.
  for (let x = mapData.minX; x < mapData.maxX; x++) {
    for (let y = mapData.minY; y < mapData.maxY; y++) {
      const key = getKeyString(x, y);//DÃ¹ng getKeyString(x, y) Ä‘á»ƒ chuyá»ƒn vá» chuá»—i kiá»ƒu "x3y5" hoáº·c "3x5".

      // Bá» qua náº¿u trong danh sÃ¡ch cáº¥m
      if (bannedSpots.includes(key)) continue;

      // Bá» qua náº¿u bá»‹ block, cÃ³ coin, hoáº·c cÃ³ player
      const hasCoin = coins[key];//coins[key]: kiá»ƒm tra cÃ³ coin á»Ÿ vá»‹ trÃ­ Ä‘Ã³ khÃ´ng.
      const hasPlayer = Object.values(players).some(p => p.x === x && p.y === y);//Object.values(players).some(...): kiá»ƒm tra cÃ³ ngÆ°á»i chÆ¡i nÃ o Ä‘ang á»Ÿ vá»‹ trÃ­ Ä‘Ã³ khÃ´ng.

      //Náº¿u Ã´ Ä‘Ã³ khÃ´ng solid, khÃ´ng coin, khÃ´ng player â†’ thÃªm vÃ o danh sÃ¡ch:
      if (!isSolid(x, y) && !hasCoin && !hasPlayer) {
        safeSpots.push({ x, y });
      }
    }
  }

   //Tráº£ vá» má»™t Ã´ ngáº«u nhiÃªn hoáº·c vá»‹ trÃ­ máº·c Ä‘á»‹nh:
  if (safeSpots.length === 0) return { x: mapData.minX, y: mapData.minY };//Náº¿u khÃ´ng cÃ³ Ã´ an toÃ n nÃ o â†’ tráº£ vá» vá»‹ trÃ­ máº·c Ä‘á»‹nh (gÃ³c trÃ¡i báº£n Ä‘á»“).
  return randomFromArray(safeSpots);//Náº¿u cÃ³ â†’ chá»n ngáº«u nhiÃªn tá»« danh sÃ¡ch báº±ng randomFromArray.
}

//Els = Elements

 
    // Game state & DOM elements(Biáº¿n tráº¡ng thÃ¡i game vÃ  DOM)
    // playerId is the string of who you logged in as in firebase
    // playerRef is playerReferences to our firebase so we can actually interact with data on the database side
    let playerId, playerRef;
    //create empty variable 
    // ÄÃ¢y lÃ  cÃ¡ch khai bÃ¡o cÃ¡c biáº¿n Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u trong game. Táº¥t cáº£ Ä‘á»u lÃ  object rá»—ng, vÃ  sáº½ Ä‘Æ°á»£c cáº­p nháº­t theo thá»i gian thá»±c tá»« Firebase.


    // players is the local list of state of where every character is in the game(x,y value, color...)
    // playerEls is just a list of references to our actual dom elements
    // coins is track where the coin are
    // coinEls this references to the coin elements
    let players = {}, playerEls = {}, coins = {}, coinEls = {};
    
    // this take the DOM elements
    //DÃ²ng nÃ y dÃ¹ng Ä‘á»ƒ láº¥y pháº§n tá»­ HTML Ä‘áº§u tiÃªn cÃ³ class lÃ  game-container vÃ  lÆ°u nÃ³ vÃ o biáº¿n gameContainer.
    const gameContainer = document.querySelector(".game-container");
    //Láº¥y pháº§n tá»­ cÃ³ id="player-name" tá»« HTML.ThÆ°á»ng dÃ¹ng Ä‘á»ƒ láº¥y tÃªn ngÆ°á»i chÆ¡i do ngÆ°á»i dÃ¹ng nháº­p vÃ o.
    const playerNameInput = document.querySelector("#player-name");
    //Láº¥y pháº§n tá»­ cÃ³ id="player-color" â€“ cÃ³ thá»ƒ lÃ  nÃºt hoáº·c menu Ä‘á»ƒ chá»n mÃ u nhÃ¢n váº­t.
    const playerColorButton = document.querySelector("#player-color");

    // Game logic functions(ğŸ’° Äáº·t xu á»Ÿ vá»‹ trÃ­ an toÃ n)
//every player that in the map going to randomly fire this placeCoin() function to have coin all over the map
function placeCoin(){
  const {x, y} = getRandomSafeSpot();//Láº¥y má»™t vá»‹ trÃ­ trá»‘ng, an toÃ n
  const key = getKeyString(x, y);//Táº¡o khÃ³a Ä‘á»‹nh danh (vÃ­ dá»¥: "5x3")

  // TrÃ¡nh trÃ¹ng key
  if (!coins[key]) {
    set(ref(db, `coins/${key}`), { x, y });//Ghi dá»¯ liá»‡u { x, y } vÃ o Firebase dÆ°á»›i key coins/5x3 (vÃ­ dá»¥)GiÃºp báº¡n Ä‘á»‹nh danh Ä‘á»“ng xu theo vá»‹ trÃ­ Ä‘á»ƒ:TrÃ¡nh trÃ¹ng Dá»… xÃ³a khi cáº§n
  }

  // Äáº·t coin má»›i sau 2-5 giÃ¢y(2000 - 5000 miliseconds)
  setTimeout(placeCoin, randomFromArray([2000,3000,4000,5000]));
}

//ğŸª™ NgÆ°á»i chÆ¡i thu tháº­p xu
    function attemptGrabCoin(x, y){
      const key = getKeyString(x,y);//getKeyString(x, y) â†’ biáº¿n vá»‹ trÃ­ x,y thÃ nh chuá»—i key, vÃ­ dá»¥ "4x2".
      if (coins[key]) {// Náº¿u cÃ³ Ä‘á»“ng xu táº¡i vá»‹ trÃ­ Ä‘Ã³
        remove(ref(db, `coins/${key}`));//XÃ³a Ä‘á»“ng xu trÃªn Firebase (remove(...)) â‡’ táº¥t cáº£ client Ä‘á»u Ä‘Æ°á»£c cáº­p nháº­t vÃ¬ cÃ³ listener onChildRemoved(...).
        update(playerRef, { coins: players[playerId].coins + 1 });//Cáº­p nháº­t sá»‘ xu ngÆ°á»i chÆ¡i cÃ³ báº±ng cÃ¡ch tÄƒng coins lÃªn 1.
      }
    }
//â¬…ï¸â¡ï¸ Di chuyá»ƒn ngÆ°á»i chÆ¡i
//Äoáº¡n hÃ m handleArrowPress(dx, dy) nÃ y xá»­ lÃ½ viá»‡c ngÆ°á»i chÆ¡i di chuyá»ƒn trong game (theo hÆ°á»›ng mÅ©i tÃªn hoáº·c phÃ­m WASD). ÄÃ¢y lÃ  má»™t pháº§n quan trá»ng Ä‘á»ƒ cáº­p nháº­t vá»‹ trÃ­ ngÆ°á»i chÆ¡i trong Firebase Realtime Database.
/*
HÃ m nÃ y nháº­n 2 tham sá»‘ dx vÃ  dy, biá»ƒu thá»‹ hÆ°á»›ng di chuyá»ƒn:
    VÃ­ dá»¥: dx = 1, dy = 0 lÃ  Ä‘i sang pháº£i.
    dx = 0, dy = -1 lÃ  Ä‘i lÃªn.
*/
function handleArrowPress(dx=0, dy=0){
  //TÃ­nh vá»‹ trÃ­ x,y má»›i dá»±a vÃ o vá»‹ trÃ­ hiá»‡n táº¡i cá»§a ngÆ°á»i chÆ¡i.
      const newX = players[playerId].x + dx;
      const newY = players[playerId].y + dy;

/*
isSolid(x, y) kiá»ƒm tra xem Ã´ Ä‘Ã³ cÃ³ Ä‘i vÃ o Ä‘Æ°á»£c khÃ´ng.
Tráº£ vá» true náº¿u lÃ  tÆ°á»ng/chÆ°á»›ng ngáº¡i â†’ khÃ´ng Ä‘Æ°á»£c Ä‘i.
Náº¿u khÃ´ng solid thÃ¬ má»›i cho phÃ©p di chuyá»ƒn.
*/
      if (!isSolid(newX, newY)) {
        //Cáº­p nháº­t vá»‹ trÃ­ x,y má»›i cá»§a ngÆ°á»i chÆ¡i á»Ÿ phÃ­a local (bá»™ nhá»› trÃ¬nh duyá»‡t).
        players[playerId].x = newX;
        players[playerId].y = newY;


        /*
        Cáº­p nháº­t hÆ°á»›ng ngÆ°á»i chÆ¡i:
        Náº¿u Ä‘i pháº£i (dx > 0) â†’ "right".
        Náº¿u Ä‘i trÃ¡i (dx < 0) â†’ "left".
        Náº¿u Ä‘i lÃªn/xuá»‘ng â†’ giá»¯ nguyÃªn hÆ°á»›ng cÅ©.
        */
        players[playerId].direction = dx > 0 ? "right" : dx < 0 ? "left" : players[playerId].direction;
        
        //set the new value of the player
        set(playerRef, players[playerId]);//Ghi toÃ n bá»™ dá»¯ liá»‡u má»›i cá»§a ngÆ°á»i chÆ¡i lÃªn Firebase (Realtime Database).Firebase sáº½ tá»± Ä‘á»™ng gá»­i báº£n cáº­p nháº­t Ä‘áº¿n táº¥t cáº£ ngÆ°á»i chÆ¡i khÃ¡c.
        //call the  attemptGrabCoin function
        attemptGrabCoin(newX, newY);//HÃ m nÃ y kiá»ƒm tra xem ngÆ°á»i chÆ¡i cÃ³ Ä‘ang Ä‘á»©ng trÃªn Ã´ cÃ³ xu khÃ´ng.Náº¿u cÃ³, thÃ¬ láº¥y xu Ä‘Ã³ (vÃ  cáº­p nháº­t coin, xÃ³a xu khá»i Firebase...).
      }
    }
//âš™ï¸ Khá»Ÿi Ä‘á»™ng game
    function initGame(){
      // Báº¯t sá»± kiá»‡n phÃ­m mÅ©i tÃªn
      //Láº·p qua tá»«ng mÃ£ phÃ­m mÅ©i tÃªn.
      ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].forEach(code => {
        //Biáº¿n ok dÃ¹ng Ä‘á»ƒ ngÄƒn viá»‡c nháº¥n giá»¯ phÃ­m sáº½ gá»i liÃªn tá»¥c. Chá»‰ cho phÃ©p gá»i 1 láº§n má»—i láº§n nháº¥n xuá»‘ng.
        let ok = true;

        
        window.addEventListener("keydown", e => {
          if (e.code === code && ok) {//Khi nháº¥n phÃ­m vÃ  Ä‘Ãºng mÃ£ (e.code === code) vÃ  ok === true, thÃ¬:
            ok = false;//Äáº·t ok = false Ä‘á»ƒ khÃ³a láº¡i, chá» ngÆ°á»i dÃ¹ng tháº£ phÃ­m má»›i cho nháº¥n láº§n tiáº¿p.

            
            /*
Táº¡o object moves Ä‘á»ƒ Ã¡nh xáº¡ tá»«ng phÃ­m sang hÆ°á»›ng di chuyá»ƒn (dx, dy):
    LÃªn: y - 1
    Xuá»‘ng: y + 1
    TrÃ¡i: x - 1
    Pháº£i: x + 1
Sau Ä‘Ã³ gá»i handleArrowPress(dx, dy) vá»›i hÆ°á»›ng tÆ°Æ¡ng á»©ng.                        
            */
            const moves = {ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};
            handleArrowPress(...moves[code]);
          }
        });
        window.addEventListener("keyup", e=>{ if(e.code===code) ok=true; });
      });

      // Láº¯ng nghe dá»¯ liá»‡u ngÆ°á»i chÆ¡i vÃ  coin trong Firebase
      const pRef = ref(db, "players");//tham chiáº¿u (reference) Ä‘áº¿n nÆ¡i lÆ°u táº¥t cáº£ ngÆ°á»i chÆ¡i vÃ  bá» vÃ o biáº¿n pRef
      const cRef = ref(db, "coins");//tham chiáº¿u (reference) Ä‘áº¿n nÆ¡i lÆ°u táº¥t cáº£ cÃ¡c Ä‘á»“ng xu trong game vÃ  bá» vÃ o biáº¿n cRef

/*
onValue(pRef, snap => {
  // xá»­ lÃ½ dá»¯ liá»‡u á»Ÿ Ä‘Ã¢y
});
ÄÃ¢y lÃ  má»™t hÃ m cá»§a Firebase Realtime Database dÃ¹ng Ä‘á»ƒ:
Nghe thá»i gian thá»±c khi dá»¯ liá»‡u táº¡i pRef thay Ä‘á»•i (á»Ÿ Ä‘Ã¢y lÃ  players).
ThÃ nh pháº§n	Ã nghÄ©a
onValue(...)	Thiáº¿t láº­p listener thá»i gian thá»±c cho má»™t vá»‹ trÃ­ trong database
pRef	LÃ  ref(db, "players") â€“ vá»‹ trÃ­ chá»©a toÃ n bá»™ ngÆ°á»i chÆ¡i
snap (snapshot)	LÃ  Ä‘á»‘i tÆ°á»£ng chá»©a dá»¯ liá»‡u táº¡i players thá»i Ä‘iá»ƒm hiá»‡n táº¡i
snap.val()	Tráº£ vá» dá»¯ liá»‡u dáº¡ng object tá»« snapshot
*/

      // Fires whenever a change orrcurs
      onValue(pRef, snap => { //This callback will happen whenever player join leave or new modification
        players = snap.val() || {};//Láº¥y toÃ n bá»™ danh sÃ¡ch ngÆ°á»i chÆ¡i tá»« Firebase.Náº¿u khÃ´ng cÃ³ gÃ¬ (null), gÃ¡n rá»—ng {}.
        
        /*
        Láº·p qua tá»«ng ngÆ°á»i chÆ¡i.
        k lÃ  playerId.
        s lÃ  dá»¯ liá»‡u chi tiáº¿t ngÆ°á»i chÆ¡i (name, x, y, coins,...).
        el lÃ  pháº§n tá»­ HTML tÆ°Æ¡ng á»©ng (náº¿u Ä‘Ã£ táº¡o).
        */
        for (const k of Object.keys(players)) {
          const s = players[k], el = playerEls[k];
          
          
          if (el) { //Náº¿u ngÆ°á»i chÆ¡i Ä‘Ã³ Ä‘Ã£ cÃ³ trÃªn giao diá»‡n (el tá»“n táº¡i),Cáº­p nháº­t láº¡i thÃ´ng tin: tÃªn, xu, vá»‹ trÃ­, hÆ°á»›ng, mÃ u,...
            //Fill in some initial state

            /*2 dÃ²ng  dÆ°á»›i nÃ y dÃ¹ng Ä‘á»ƒ cáº­p nháº­t ná»™i dung bÃªn trong pháº§n tá»­ HTML el, cá»¥ thá»ƒ lÃ :

              TÃªn ngÆ°á»i chÆ¡i (class Character_name)

              Sá»‘ xu (class Character_coins)

              â€¦dá»±a trÃªn dá»¯ liá»‡u má»›i tá»« Firebase (s).*/
            el.querySelector(".Character_name").innerText = s.name;//TÃ¬m pháº§n tá»­ con cÃ³ class .Character_name trong el.Thay Ä‘á»•i ná»™i dung vÄƒn báº£n (innerText) thÃ nh s.name
            el.querySelector(".Character_coins").innerText = s.coins;//TÃ¬m pháº§n tá»­ con cÃ³ class .Character_coins trong el.GÃ¡n láº¡i sá»‘ xu thÃ nh s.coins
           
           /*
            data-color	MÃ u sáº¯c cá»§a nhÃ¢n váº­t (vÃ­ dá»¥: "red", "blue",...)
            data-direction	HÆ°á»›ng nhÃ¢n váº­t Ä‘ang quay máº·t (vÃ­ dá»¥: "left", "right", "up", "down")
            */
            el.dataset.color = s.color;// css basically use this value to position the sprite sheet correctly to show the right color
            el.dataset.direction = s.direction;// use the css value to either show the left facing frame or the right facing frame


            /*
            ÄÃ¢y lÃ  cÃ¡ch di chuyá»ƒn pháº§n tá»­ nhÃ¢n váº­t (el) trÃªn báº£n Ä‘á»“ lÆ°á»›i báº±ng CSS.
            Sá»­ dá»¥ng transform: translate3d(...) Ä‘á»ƒ Ä‘áº·t vá»‹ trÃ­ chÃ­nh xÃ¡c trong khÃ´ng gian 2D (hoáº·c 3D).
            translate3d(x, y, z)
            Di chuyá»ƒn pháº§n tá»­ theo tá»a Ä‘á»™ X, Y vÃ  Z
            Æ¯u Ä‘iá»ƒm: mÆ°á»£t, tá»‘i Æ°u hiá»‡u nÄƒng (GPU rendering)
             CÃ´ng thá»©c tÃ­nh:
            âœ… 16 * s.x:

                Má»—i Ã´ trong báº£n Ä‘á»“ cÃ³ kÃ­ch thÆ°á»›c 16px

                s.x lÃ  vá»‹ trÃ­ hÃ ng ngang

                Di chuyá»ƒn pháº§n tá»­ sang trÃ¡i/pháº£i

            âœ… 16 * s.y - 4:

                TÆ°Æ¡ng tá»±: vá»‹ trÃ­ hÃ ng dá»c

                Trá»« 4 Ä‘á»ƒ cÄƒn chá»‰nh nhÃ¢n váº­t lá»‡ch lÃªn má»™t chÃºt, do pháº§n sprite thÆ°á»ng váº½ Ä‘áº§u nhÃ¢n váº­t hÆ¡i cao

            âœ… 0:

                Trá»¥c z (khÃ´ng dÃ¹ng trong 2D, nÃªn Ä‘áº·t lÃ  0)
            */
           //-4 to make the character fell like in the middle of the cell
            el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;
          }
        }
      });

/*

// Khi cÃ³ ngÆ°á»i chÆ¡i má»›i
onChildAdded(pRef, snap => {
  // xá»­ lÃ½ dá»¯ liá»‡u ngÆ°á»i chÆ¡i má»›i
});
ÄÃ¢y lÃ  má»™t hÃ m cá»§a Firebase Realtime Database dÃ¹ng Ä‘á»ƒ láº¯ng nghe sá»± kiá»‡n khi cÃ³ â€œchildâ€ má»›i Ä‘Æ°á»£c thÃªm vÃ o má»™t nÃºt trong database â€“ á»Ÿ Ä‘Ã¢y lÃ  players/.
ThÃ nh pháº§n	Ã nghÄ©a
pRef	Tham chiáº¿u tá»›i "players" â€“ danh sÃ¡ch ngÆ°á»i chÆ¡i
onChildAdded(...)	Láº¯ng nghe má»—i khi cÃ³ ngÆ°á»i chÆ¡i má»›i Ä‘Æ°á»£c thÃªm vÃ o database
snap	Snapshot chá»©a dá»¯ liá»‡u cá»§a ngÆ°á»i chÆ¡i vá»«a Ä‘Æ°á»£c thÃªm
snap.val()	Tráº£ vá» dá»¯ liá»‡u ngÆ°á»i chÆ¡i (name, x, y, ...)
snap.key	LÃ  playerId (UID) cá»§a ngÆ°á»i chÆ¡i
*/





/*
ThÃ nh pháº§n	Ã nghÄ©a
snap	LÃ  má»™t snapshot do Firebase tráº£ vá», chá»©a dá»¯ liá»‡u táº¡i vá»‹ trÃ­ nÃ o Ä‘Ã³ trong database
snap.val()	Tráº£ vá» giÃ¡ trá»‹ gá»‘c dÆ°á»›i dáº¡ng object, string, number,... tÃ¹y loáº¡i dá»¯ liá»‡u
const s	LÃ  biáº¿n dÃ¹ng Ä‘á»ƒ lÆ°u dá»¯ liá»‡u vá»«a láº¥y Ä‘Æ°á»£c
*/

      //Fires whenever a new node is added the tree
      onChildAdded(pRef, snap => {
        const s = snap.val();//CÃ¢u nÃ y láº¥y giÃ¡ trá»‹ dá»¯ liá»‡u thá»±c táº¿ tá»« má»™t snapshot Firebase (snap), vÃ  gÃ¡n nÃ³ vÃ o biáº¿n s.
        const el = document.createElement("div");//DÃ²ng nÃ y dÃ¹ng Ä‘á»ƒ táº¡o má»™t tháº» <div> má»›i báº±ng JavaScript, chÆ°a Ä‘Æ°á»£c gáº¯n vÃ o DOM.(el	Biáº¿n chá»©a pháº§n tá»­ DOM vá»«a táº¡o ra)
        
        /*
      el.className = `Character grid-cell${s.id === playerId ? " you" : ""}`;
      DÃ²ng nÃ y gÃ¡n class CSS cho pháº§n tá»­ el (vÃ­ dá»¥ má»™t <div>), Ä‘á»ƒ:
      Nháº­n diá»‡n Ä‘Ã³ lÃ  má»™t nhÃ¢n váº­t (Character)
      Vá»‹ trÃ­ theo lÆ°á»›i (grid-cell)
      VÃ  náº¿u Ä‘Ã³ lÃ  ngÆ°á»i chÆ¡i hiá»‡n táº¡i, thÃ¬ thÃªm class "you" Ä‘á»ƒ phÃ¢n biá»‡t
    

    ThÃ nh pháº§n	Ã nghÄ©a
    `Character grid-cell${...}`	Template string â€” táº¡o ra chuá»—i class CSS Ä‘á»™ng
    s.id	ID cá»§a ngÆ°á»i chÆ¡i hiá»‡n táº¡i trong vÃ²ng láº·p Firebase snapshot
    playerId	UID cá»§a ngÆ°á»i chÆ¡i Ä‘ang Ä‘Äƒng nháº­p (tá»« auth.currentUser.uid)
    s.id === playerId ? " you" : ""	Náº¿u lÃ  ngÆ°á»i chÆ¡i hiá»‡n táº¡i, thÃªm class "you", ngÆ°á»£c láº¡i khÃ´ng thÃªm
    */
        
        el.className = `Character grid-cell${s.id===playerId? " you":""}`;
        /*
        Character_shadow	BÃ³ng Ä‘á»• cá»§a nhÃ¢n váº­t (hiá»‡u á»©ng hÃ¬nh áº£nh dÆ°á»›i chÃ¢n)
        Character_sprite	áº¢nh chÃ­nh cá»§a nhÃ¢n váº­t (sprite 2D hoáº·c hoáº¡t hÃ¬nh)
        Character_name-container	Khung chá»©a thÃ´ng tin ngÆ°á»i chÆ¡i
        Character_name	TÃªn ngÆ°á»i chÆ¡i hiá»ƒn thá»‹ phÃ­a trÃªn nhÃ¢n váº­t
        Character_coins	Sá»‘ lÆ°á»£ng xu ngÆ°á»i chÆ¡i Ä‘ang cÃ³, hiá»ƒn thá»‹ cáº¡nh tÃªn hoáº·c bÃªn dÆ°á»›i
        */
        el.innerHTML = `
          <div class="Character_shadow grid-cell"></div>
          <div class="Character_sprite grid-cell"></div>
          <div class="Character_name-container">
            <span class="Character_name">${s.name}</span>
            <span class="Character_coins">${s.coins}</span>
          </div>
          <div class="Character_you-arrow"></div>
        `;
        el.dataset.color = s.color;
        el.dataset.direction = s.direction;
        el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;
        gameContainer.appendChild(el);
        playerEls[s.id] = el;//DÃ²ng nÃ y lÆ°u pháº§n tá»­ HTML (el) Ä‘áº¡i diá»‡n cho ngÆ°á»i chÆ¡i vÃ o object playerEls, vá»›i key lÃ  s.id, tá»©c lÃ  UID cá»§a ngÆ°á»i chÆ¡i Ä‘Ã³.
      });



/*
onChildRemoved: Sá»± kiá»‡n cá»§a Firebase Realtime Database, Ä‘Æ°á»£c gá»i khi má»™t "child" (ngÆ°á»i chÆ¡i) bá»‹ xÃ³a khá»i players.
pRef: lÃ  tham chiáº¿u tá»›i players trong database (ref(db, "players")).
snap: lÃ  dá»¯ liá»‡u snapshot bá»‹ xÃ³a.
*/


      // Khi cÃ³ ngÆ°á»i rá»i game
      onChildRemoved(pRef, snap => {
        const id = snap.val().id;//Láº¥y id ngÆ°á»i chÆ¡i (tá»©c uid cá»§a Firebase).
        const el = playerEls[id];//Láº¥y pháº§n tá»­ DOM (nhÃ¢n váº­t) tÆ°Æ¡ng á»©ng vá»›i ngÆ°á»i chÆ¡i Ä‘Ã³, tá»« biáº¿n playerEls.
        //Náº¿u cÃ³ pháº§n tá»­ DOM tá»“n táº¡i:XÃ³a nhÃ¢n váº­t ra khá»i gameContainer.XÃ³a khá»i danh sÃ¡ch playerEls Ä‘á»ƒ giáº£i phÃ³ng bá»™ nhá»›.
        if (el) { gameContainer.removeChild(el); delete playerEls[id]; }
      });

      onValue(cRef, snap => { coins = snap.val() || {}; });

      // Khi cÃ³ coin má»›i
      onChildAdded(cRef, snap => {//cRef lÃ  ref(db, "coins") â€“ tham chiáº¿u Ä‘áº¿n táº¥t cáº£ Ä‘á»“ng xu trong cÆ¡ sá»Ÿ dá»¯ liá»‡u Firebase.Sá»± kiá»‡n onChildAdded sáº½ Ä‘Æ°á»£c gá»i má»—i khi cÃ³ Ä‘á»“ng xu má»›i xuáº¥t hiá»‡n.
        const s = snap.val(), key=getKeyString(s.x, s.y);//s chá»©a dá»¯ liá»‡u vá»‹ trÃ­ cá»§a coin (vÃ­ dá»¥: {x: 5, y: 4})getKeyString(x, y) sáº½ chuyá»ƒn tá»a Ä‘á»™ thÃ nh má»™t chuá»—i Ä‘á»‹nh danh, vÃ­ dá»¥: "5x4"
        //DÃ¹ng key lÃ m chá»‰ sá»‘ Ä‘á»ƒ ghi láº¡i ráº±ng cÃ³ coin á»Ÿ vá»‹ trÃ­ Ä‘Ã³:
        coins[key] = true;

      //Táº¡o má»™t tháº» <div> má»›i cÃ³ class "Coin" (Ä‘á»ƒ CSS xá»­ lÃ½ hiá»‡u á»©ng) vÃ  "grid-cell" (cÄƒn theo lÆ°á»›i game).
        const el = document.createElement("div");
        el.className = "Coin grid-cell";
        /*
        ThÃªm 2 lá»›p con:
        "Coin_shadow": táº¡o bÃ³ng
        "Coin_sprite": hÃ¬nh áº£nh coin tháº­t
        */
        el.innerHTML = `
          <div class="Coin_shadow grid-cell"></div>
          <div class="Coin_sprite grid-cell"></div>
        `;
        // Position the Element
        el.style.transform = `translate3d(${16*s.x}px,${16*s.y-4}px,0)`;//CÄƒn vá»‹ trÃ­ Ä‘á»“ng xu trÃªn lÆ°á»›i báº±ng cÃ¡ch nhÃ¢n tá»a Ä‘á»™ vá»›i 16px (kÃ­ch thÆ°á»›c 1 Ã´ vuÃ´ng).CÄƒn vá»‹ trÃ­ Ä‘á»“ng xu trÃªn lÆ°á»›i báº±ng cÃ¡ch nhÃ¢n tá»a Ä‘á»™ vá»›i 16px (kÃ­ch thÆ°á»›c 1 Ã´ vuÃ´ng).Trá»« Ä‘i 4px Ä‘á»ƒ cÄƒn giá»¯a theo chiá»u dá»c (tÃ¹y hÃ¬nh áº£nh coin).



        /*
      gameContainer: lÃ  má»™t pháº§n tá»­ HTML, thÆ°á»ng lÃ  tháº» <div class="game-container">

      el: lÃ  má»™t pháº§n tá»­ DOM má»›i (thÆ°á»ng lÃ  nhÃ¢n váº­t, Ä‘á»“ng xu, v.v.)

      .appendChild(el): thÃªm el vÃ o cuá»‘i danh sÃ¡ch con cá»§a gameContainer

    Khi nÃ o cáº§n?

    Khi thÃªm nhÃ¢n váº­t má»›i vÃ o báº£n Ä‘á»“

    Khi sinh ra Ä‘á»“ng xu (coin)

    Khi váº½ cÃ¡c pháº§n tá»­ cá»§a trÃ² chÆ¡i (map, váº­t pháº©mâ€¦)
      */


        gameContainer.appendChild(el);//DÃ²ng nÃ y dÃ¹ng Ä‘á»ƒ thÃªm pháº§n tá»­ el vÃ o bÃªn trong pháº§n tá»­ gameContainer.
        coinEls[key] = el;
      });

      // Khi coin bá»‹ nháº·t
      onChildRemoved(cRef, snap => {//cRef lÃ  ref(db, "coins") â€” tham chiáº¿u Ä‘áº¿n pháº§n dá»¯ liá»‡u chá»©a táº¥t cáº£ Ä‘á»“ng xu trong Firebase.onChildRemoved sáº½ Ä‘Æ°á»£c kÃ­ch hoáº¡t khi má»™t Ä‘á»“ng xu bá»‹ xÃ³a khá»i cÆ¡ sá»Ÿ dá»¯ liá»‡u.
        const {x, y} = snap.val(), key = getKeyString(x,y);//Láº¥y tá»a Ä‘á»™ cá»§a Ä‘á»“ng xu bá»‹ xÃ³a.Chuyá»ƒn Ä‘á»•i tá»a Ä‘á»™ thÃ nh key Ä‘á»‹nh danh chuá»—i nhÆ° "5x3".
        const el = coinEls[key];//TÃ¬m pháº§n tá»­ HTML tÆ°Æ¡ng á»©ng vá»›i Ä‘á»“ng xu trong danh sÃ¡ch coinEls.
        if (el) { gameContainer.removeChild(el); delete coinEls[key]; }//Náº¿u pháº§n tá»­ tá»“n táº¡i:Gá»¡ nÃ³ khá»i DOM (gameContainer)XÃ³a khá»i danh sÃ¡ch coinEls Ä‘á»ƒ giáº£i phÃ³ng bá»™ nhá»›
      });

      // Äá»•i tÃªn ngÆ°á»i chÆ¡i
      // Äoáº¡n mÃ£ nÃ y giÃºp cáº­p nháº­t tÃªn ngÆ°á»i chÆ¡i trong cÆ¡ sá»Ÿ dá»¯ liá»‡u Firebase khi ngÆ°á»i chÆ¡i thay Ä‘á»•i tÃªn trong Ã´ input.
      playerNameInput.addEventListener("change", e => {//Khi ngÆ°á»i chÆ¡i Ä‘á»•i ná»™i dung trong Ã´ input tÃªn (#player-name) vÃ  nháº¥n Enter hoáº·c click ra ngoÃ i, sá»± kiá»‡n "change" sáº½ xáº£y ra.
        const nm = e.target.value || createName();//Láº¥y giÃ¡ trá»‹ má»›i tá»« Ã´ input (e.target.value).Náº¿u ngÆ°á»i chÆ¡i xÃ³a háº¿t chá»¯ (tÃªn trá»‘ng), thÃ¬ sáº½ gá»i createName() Ä‘á»ƒ táº¡o tÃªn má»›i ngáº«u nhiÃªn.
        
        //set is set the entire value 
        //update is update just one property in that node(EX: below only update the key:value (name: nm))
        playerNameInput.value = nm;//Äáº£m báº£o Ã´ input luÃ´n hiá»ƒn thá»‹ tÃªn há»£p lá»‡ (dÃ¹ ngÆ°á»i chÆ¡i Ä‘Ã£ xÃ³a tÃªn â†’ sáº½ tá»± Ä‘á»™ng táº¡o láº¡i).
        update(playerRef, { name: nm });//Cáº­p nháº­t tÃªn má»›i (nm) vÃ o Realtime Database Firebase, táº¡i vá»‹ trÃ­ players/playerId.playerRef lÃ  ref(db, 'players/PLAYER_ID').
      });

      // Äá»•i mÃ u ngÆ°á»i chÆ¡i
      playerColorButton.addEventListener("click", () => {//Khi ngÆ°á»i chÆ¡i nháº¥n nÃºt Ä‘á»•i mÃ u, hÃ m bÃªn trong sáº½ Ä‘Æ°á»£c gá»i.
        const i = playerColors.indexOf(players[playerId].color);//TÃ¬m vá»‹ trÃ­ hiá»‡n táº¡i cá»§a mÃ u ngÆ°á»i chÆ¡i Ä‘ang dÃ¹ng trong máº£ng playerColors (vÃ­ dá»¥: ["red", "orange", "yellow", ...]).
        const next = playerColors[(i+1) % playerColors.length];//TÃ¬m mÃ u tiáº¿p theo trong danh sÃ¡ch (xoay vÃ²ng):Náº¿u Ä‘ang lÃ  mÃ u cuá»‘i thÃ¬ quay láº¡i mÃ u Ä‘áº§u.DÃ¹ng % Ä‘á»ƒ khÃ´ng bá»‹ lá»—i vÆ°á»£t máº£ng.
        
        //set is set the entire value 
        //update is update just one property in that node(EX: below only update the key:value (color: next))
        update(playerRef, { color: next });//Cáº­p nháº­t Firebase: thay Ä‘á»•i mÃ u nhÃ¢n váº­t thÃ nh next.playerRef lÃ  Ä‘Æ°á»ng dáº«n Firebase Ä‘áº¿n ngÆ°á»i chÆ¡i hiá»‡n táº¡i (players/{playerId}).
      });

      placeCoin();// Báº¯t Ä‘áº§u Ä‘áº·t coin
    }

    // Sau khi DOM sáºµn sÃ ng(Khi trang load hoÃ n táº¥t)
    window.addEventListener("load", () => {
      onAuthStateChanged(auth, user => {
        if (user) {
          playerId = user.uid;
          playerRef = ref(db, `players/${playerId}`);

          const name = createName();//Gá»i hÃ m createName() Ä‘á»ƒ táº¡o má»™t tÃªn ngáº«u nhiÃªn (cÃ³ thá»ƒ lÃ  nhÆ° "FunnyCat123" hoáº·c "BlueTiger"â€¦).Biáº¿n name chá»©a giÃ¡ trá»‹ tÃªn Ä‘Ã³.
          playerNameInput.value = name;//GÃ¡n tÃªn vá»«a táº¡o vÃ o Ã´ input nháº­p tÃªn (#player-name), Ä‘á»ƒ ngÆ°á»i chÆ¡i tháº¥y tÃªn máº·c Ä‘á»‹nh cá»§a há».VÃ­ dá»¥: náº¿u tÃªn ngáº«u nhiÃªn lÃ  "FastFox", thÃ¬ ngÆ°á»i dÃ¹ng sáº½ tháº¥y:

          const { x, y } = getRandomSafeSpot();
          
          // Táº¡o ngÆ°á»i chÆ¡i má»›i trong Firebase
          set(playerRef, {
            id: playerId,
            name, direction: "right",
            color: randomFromArray(playerColors),
            x, y, coins: 0
          });

          onDisconnect(playerRef).remove();// XÃ³a khi máº¥t káº¿t ná»‘i
          initGame();// Báº¯t Ä‘áº§u game
        }
      });
      signInAnonymously(auth).catch(console.error);
    });

  //ğŸš« Vá»‹ trÃ­ cáº¥m
  const bannedSpots = [
  "8x3", "9x3",         // Gháº¿ Ä‘á» bÃªn pháº£i
  "6x3", "7x3",         // BÃ n giá»¯a
  "3x3", "4x3",         // BÃ n trÃ¡i
  "4x2", "2x2",         // Gháº¿ trÃªn
  "7x5",                // VÃ¹ng ná»n xanh dÆ°Æ¡ng (vÃ­ dá»¥)
  "5x1", "6x1",         // Khu xanh dÆ°Æ¡ng trÃªn cÃ¹ng (cafe-pizza)
  // ... thÃªm tiáº¿p cÃ¡c tá»a Ä‘á»™ khÃ¡c náº¿u cáº§n
];

//âŒ¨ï¸ Lá»›p láº¯ng nghe phÃ­m nháº¥n
/*ÄÃ¢y lÃ  má»™t lá»›p (class) JavaScript cÃ³ tÃªn KeyPressListener, dÃ¹ng Ä‘á»ƒ láº¯ng nghe má»™t phÃ­m nháº¥t Ä‘á»‹nh Ä‘Æ°á»£c nháº¥n xuá»‘ng (keydown), vÃ  chá»‰ gá»i callback() má»™t láº§n cho má»—i láº§n nháº¥n, khÃ´ng bá»‹ spam khi ngÆ°á»i dÃ¹ng giá»¯ phÃ­m.*/
  class KeyPressListener {
/*
    keyCode: tÃªn phÃ­m cáº§n láº¯ng nghe (vÃ­ dá»¥ "ArrowUp", "KeyW", "Space").
    callback: hÃ m sáº½ cháº¡y khi phÃ­m Ä‘Ã³ Ä‘Æ°á»£c nháº¥n.
    keySafe = true: biáº¿n cá» Ä‘áº£m báº£o callback chá»‰ Ä‘Æ°á»£c gá»i 1 láº§n má»—i láº§n nháº¥n (giá»¯ phÃ­m khÃ´ng gá»i láº¡i liÃªn tá»¥c).
*/
  constructor(keyCode, callback) {
  let keySafe = true;
  /*
  khi phÃ­m tÆ°Æ¡ng á»©ng Ä‘Æ°á»£c nháº¥n (event.code === keyCode) vÃ  keySafe váº«n lÃ  true:
    callback() Ä‘Æ°á»£c gá»i.
    keySafe = false Ä‘á»ƒ cháº·n láº·p láº¡i khi giá»¯ phÃ­m.
  */
    this.keydownFunction = function(event) {
      if (event.code === keyCode) {
         if (keySafe) {
            keySafe = false;
            callback();
         }  
      }
   };

   /*
    khi tháº£ phÃ­m ra, náº¿u Ä‘Ãºng lÃ  phÃ­m Ä‘Æ°á»£c theo dÃµi (keyCode),
    ThÃ¬ Ä‘áº·t keySafe = true, Ä‘á»ƒ láº§n sau cÃ³ thá»ƒ nháº­n callback má»›i khi nháº¥n láº¡i.
ğŸ§  VÃ¬ sao cáº§n keySafe?
    Khi giá»¯ phÃ­m, trÃ¬nh duyá»‡t tá»± Ä‘á»™ng táº¡o nhiá»u keydown liÃªn tá»¥c.
    keySafe Ä‘áº£m báº£o callback chá»‰ cháº¡y má»™t láº§n duy nháº¥t cho má»—i láº§n nháº¥n.
   */
   this.keyupFunction = function(event) {
      if (event.code === keyCode) {
         keySafe = true;
      }         
   };


   /*
   Gáº¯n 2 hÃ m keydownFunction vÃ  keyupFunction vÃ o tÃ i liá»‡u.
   Khi ngÆ°á»i dÃ¹ng nháº¥n hoáº·c tháº£ phÃ­m, chÆ°Æ¡ng trÃ¬nh sáº½ xá»­ lÃ½.
   */
   document.addEventListener("keydown", this.keydownFunction);
   document.addEventListener("keyup", this.keyupFunction);
  }


/*
Loáº¡i bá» (removeEventListener) cÃ¡c hÃ m Ä‘Ã£ gáº¯n vÃ o sá»± kiá»‡n keydown vÃ  keyup.
TrÃ¡nh gÃ¢y trÃ n bá»™ nhá»›, hoáº·c callback cháº¡y sai náº¿u ngÆ°á»i chÆ¡i rá»i mÃ n hÃ¬nh, hoáº·c Ä‘á»•i nhÃ¢n váº­t,...
*/
// Há»§y láº¯ng nghe phÃ­m
  unbind() { 
    document.removeEventListener("keydown", this.keydownFunction);
    document.removeEventListener("keyup", this.keyupFunction);
  }

}

  </script>


</body>

</html>
<!--firebase deploy (go nay trong terminal de deploy web)-->

<!--Coi tá»›i khÃºc 22:28-->